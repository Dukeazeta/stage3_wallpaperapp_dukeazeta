name: Build Desktop Releases

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Enable Windows desktop
        run: flutter config --enable-windows-desktop

      - name: Install dependencies
        run: flutter pub get

      - name: Build Windows release
        run: flutter build windows --release

      - name: Verify build output
        run: |
          Write-Host "Checking build directories..."
          Get-ChildItem -Path build/windows -Recurse -Directory | Select-Object FullName
          Write-Host "Looking for Release folder..."
          Get-ChildItem -Path build/windows -Filter "Release" -Recurse -Directory | Select-Object FullName
        shell: pwsh

      - name: Package Windows release
        run: |
          if (Test-Path "build/windows/x64/runner/Release") {
            cd build/windows/x64/runner/Release
            Compress-Archive -Path * -DestinationPath ../../../../../stage3_wallpaperapp_dukeazeta-windows.zip
          } elseif (Test-Path "build/windows/runner/Release") {
            cd build/windows/runner/Release
            Compress-Archive -Path * -DestinationPath ../../../../stage3_wallpaperapp_dukeazeta-windows.zip
          } else {
            Write-Error "Release folder not found!"
            exit 1
          }
        shell: pwsh

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: stage3_wallpaperapp_dukeazeta-windows.zip

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Enable macOS desktop
        run: flutter config --enable-macos-desktop

      - name: Install dependencies
        run: flutter pub get

      - name: Build macOS release
        run: flutter build macos --release

      - name: Create macOS tar archive
        run: |
          cd build/macos/Build/Products/Release
          tar -czf ../../../../stage3_wallpaperapp_dukeazeta.app.tar.gz stage3_wallpaperapp_dukeazeta.app

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-release
          path: build/stage3_wallpaperapp_dukeazeta.app.tar.gz

  create-release:
    name: Create Release
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: ./release-artifacts

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: macos-release
          path: ./release-artifacts

      - name: Generate version tag
        id: generate_tag
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"
          
          # Extract version numbers
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          # Increment patch version
          PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          
          # If this is triggered by a tag, use that tag instead
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            NEW_VERSION=${GITHUB_REF#refs/tags/}
          fi
          
          echo "New version: $NEW_VERSION"
          echo "VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create and push tag
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a ${{ steps.generate_tag.outputs.VERSION }} -m "Release ${{ steps.generate_tag.outputs.VERSION }}"
          git push origin ${{ steps.generate_tag.outputs.VERSION }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.generate_tag.outputs.VERSION }}
          name: Release ${{ steps.generate_tag.outputs.VERSION }}
          body: |
            ## ðŸŽ‰ Release ${{ steps.generate_tag.outputs.VERSION }}
            
            ### Downloads
            - **Windows:** `stage3_wallpaperapp_dukeazeta-windows.zip`
            - **macOS:** `stage3_wallpaperapp_dukeazeta.app.tar.gz`
            
            ### Installation
            - **Windows:** Download the `.zip` file, extract it, and run `stage3_wallpaperapp_dukeazeta.exe`
            - **macOS:** Download the `.app.tar.gz` file, extract it, and run the app
            
            ---
            Built automatically from commit ${{ github.sha }}
          files: |
            ./release-artifacts/stage3_wallpaperapp_dukeazeta-windows.zip
            ./release-artifacts/stage3_wallpaperapp_dukeazeta.app.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

